<include file="public@header"/>
<link href="__TMPL__/public/assets/css/common.css" rel="stylesheet">
<style>
    .layui-tab-content {
        margin-top: 15px;
    }
</style>
</head>
<body>
<div class="wrap js-check-wrap">
    <ul class="nav nav-tabs">
        <li class="active"><a href="{:url('index',array('params'=>$params))}">订单列表</a></li>
    </ul>

    <form class="well form-inline margin-top-20 layui-form ajax-form w-form-search" method="get" autocomplete="off"
          action="{:url('index')}">
        <div>
            订单号:
            <input type="text" class="form-control" name="order_num" style="width: 200px;"
                   value="{:input('order_num/s','')}" placeholder="请输入订单号">
            商品名称:
            <input type="text" class="form-control" name="goods_name" style="width: 240px;"
                   value="{:input('goods_name/s','')}" placeholder="请输入商品名称">

            下单时间:
            <input type="text" class="form-control" name="order_date" id="laydate-range-datetime" style="width: 260px;"
                   placeholder="请选择下单时间段" value="{$order_date}">


            <button type="submit" class="layui-btn" style="margin-left: 10px">搜索</button>
            <!--<a type="button" class="layui-btn layui-bg-blue ajax-export" href="javascript:;">导出</a>-->
            <a class="layui-btn layui-bg-red" href="{:url('index',array('params'=>$params))}">清空</a>
            <input type="hidden" name="is_export" class="is_export" value="0">
        </div>

    </form>
    <div class="layui-tab layui-tab-brief" lay-filter="LAY-order-tab">
        <ul class="layui-tab-title order-tab">
            <li
            <if condition="!$status">class="layui-this"</if>
            >
            <a href="{:url('index',array('order_num'=>$order_num,'goods_name'=>$goods_name,'order_date'=>$order_date))}"
               style='text-decoration:none;color: inherit'>
                全部
            </a>
            </li>
            <foreach name="count" key="key" item="vo">
                <li
                <if condition="$vo.key == $status">class="layui-this"</if>
                >
                <a href="{:url('index',array('status'=>$vo.key,'order_num'=>$order_num,'goods_name'=>$goods_name,'order_date'=>$order_date))}"
                   style='text-decoration:none;color: inherit'>
                    {$vo.name}<span class="layui-badge layui-bg-orange">{$vo.count}</span>
                </a>
                </li>
            </foreach>
        </ul>
        <div class="layui-tab-content table-responsive">
            <table class="table order-table">
                <thead>
                <tr class="tab-header">
                    <th width="60%">
                        <table class="th-table">
                            <tr>
                                <th width="5%">ID</th>
                                <th width="60%">商品信息</th>
                                <th width="10%">单价</th>
                                <th width="10%">划线价</th>
                                <th width="10%">数量</th>
                            </tr>
                        </table>
                    </th>
                    <th width="10%">运费</th>
                    <th width="10%">实付款</th>
                    <th width="10%">状态</th>
                    <th width="10%">操作</th>
                </tr>
                </thead>
                <tbody>
                <tr class="tr-pipe"></tr>
                </tbody>

                <foreach name="list" item="vo">
                    <tbody>
                    <tr class="tr-header">
                        <td colspan="5">
                            <span>(ID:{$vo.id})</span>
                            <span style="margin-left:1%;"><b>{$vo.create_time|date="Y-m-d H:i"}</b></span>
                            <span class="order_num" style="margin-left: 1%;"
                                  onclick="copyContent('{$vo.order_num}')">
                                <cite>订单号：</cite>{$vo.order_num}
                            </span>

                            <span style="margin-left: 1%;">
                             用户:
                             <a href="javascript:imagePreviewDialog('{:cmf_get_image_preview_url($vo.user_info.avatar)}');">
                                <img class="layui-circle" src="{$vo.user_info.avatar}" width="20"
                                     height="20">
                            </a>
                            </span>
                            <span ondblclick="copyContent('{$vo.user_info.openid}')">
                                (ID:{$vo.user_id}) {$vo.user_info.nickname}
                            </span>
                            <if condition="!empty($vo.remark)">
                                <i class="layui-icon layui-icon-reply-fill cursor" style="color: #FF5722"
                                   data-toggle="tooltip"
                                   title="{$vo.remark|default=''}"></i>
                            </if>

                            <span style="margin-left: 1%;">
                                店铺:
                                <a href="javascript:imagePreviewDialog('{:cmf_get_image_preview_url($vo.shop_info.logo_image)}');">
                                <img class="layui-circle" src="{$vo.shop_info.logo_image}" width="20"
                                     height="20">
                               </a>
                                <span style="margin-right: 10px;">(ID:{$vo.shop_id}) {$vo.shop_info.name}-{$vo.shop_info.phone}</span>
                            </span>


                            <span class="layui-btn layui-btn-primary layui-border-green layui-btn-xs"
                                  style="margin-left: 20px;">快递发货</span>
                        </td>
                    </tr>
                    <tr class="tr-goods">
                        <td>
                            <table class="goods-item">
                                <notempty name="$vo.goods_list">
                                    <foreach name="$vo.goods_list" item="goods" key="key">
                                        <tr>
                                            <!--<td width="5%" class="text-center">{$vo.id}</td>-->
                                            <!--id隐藏了,这里为60%-->
                                            <td width="60%">
                                                <div class="img">
                                                    <a href="javascript:imagePreviewDialog('{:cmf_get_image_preview_url($goods.image)}');">
                                                        <img class="img-rounded"
                                                             src="{:cmf_get_image_preview_url($goods.image)}" alt=""
                                                             width="70" height="70">
                                                    </a>
                                                </div>
                                                <div class="title">
                                                    {$goods.goods_name}
                                                </div>
                                                <if condition="$goods.sku_name">
                                                    <span class="tags">{$goods.sku_name}</span>
                                                </if>
                                            </td>
                                            <td width="10%" class="text-center">&yen; {$goods.goods_price}</td>
                                            <td width="10%" class="text-center">&yen; {$goods.line_price}</td>
                                            <td width="10%" class="text-center">{$goods.count}</td>
                                        </tr>
                                    </foreach>
                                </notempty>
                            </table>
                        </td>

                        <td class="text-center">
                            <div class="price">&yen; {$vo.freight_amount}</div>
                        </td>

                        <td class="text-center">
                            <div class="price">&yen; {$vo.amount}</div>
                            <notempty name="$vo.pay_time">
                                <span class="layui-btn layui-btn-primary layui-border-purple layui-btn-xs">{$vo.pay_type_name}</span>
                            </notempty>
                        </td>

                        <td class="text-center">
                            <div class="status">
                                <span class="layui-btn-xs layui-btn layui-btn-primary layui-border-orange{$vo.status_color}">{$vo.status_name}</span>
                                <if condition="10 < $vo.status">
                                    <a style="margin-left: 5px" data-toggle="tooltip" title="退款原因"
                                       href="javascript:openIframeLayer('{:url('order/reason',['id'=>$vo.id])}','查看退款原因',{area: ['800px', '460px']});">
                                        <i class="layui-icon layui-icon-question layui-font-22 layui-font-red"></i>
                                    </a>
                                </if>
                            </div>
                        </td>

                        <td class="text-center">
                            <div class="operate">
                                <a class="layui-bg-blue-light layui-circle op-btn"
                                   lay-on="order-tips"
                                   data-toggle="tooltip"
                                   data-id="{$vo.id}"
                                   title="{$vo.admin_remark?'修改备注':'添加备注'}"
                                   data-notes="{$vo.admin_remark}">
                                    <i class="layui-icon layui-icon-edit"></i>
                                </a>

                                <if condition="$vo.status==2">
                                    <a class="layui-bg-gray-light layui-circle op-btn"
                                       href="javascript:parent.openIframeLayer('{:url('send',['id'=>$vo.id])}','发货',{area: ['80%', '80%']});"
                                       data-toggle="tooltip" title="发货">
                                        <i class="layui-icon layui-icon-release"></i>
                                    </a>

                                    <a class="layui-bg-gray-light layui-circle op-btn"
                                       data-toggle="tooltip"
                                       lay-on="send-confirm"
                                       data-id="{$vo.id}"
                                       title="确认配送？">
                                        <i class="layui-icon layui-icon-release"></i>
                                    </a>
                                </if>


                                <if condition="$vo.status==12">
                                    <a class="layui-bg-gray-light layui-circle op-btn"
                                       data-toggle="tooltip"
                                       lay-on="pass-reject"
                                       data-id="{$vo.id}"
                                       title="确认退款？">
                                        <i class="layui-icon layui-icon-face-smile"></i>
                                    </a>


                                    <a class="layui-bg-gray-light layui-circle op-btn"
                                       data-toggle="tooltip"
                                       lay-on="refund-reject"
                                       data-id="{$vo.id}"
                                       title="拒绝退款？">
                                        <i class="layui-icon layui-icon-face-cry"></i>
                                    </a>
                                </if>

                                <a class="layui-bg-gray-light layui-circle op-btn"
                                   href="javascript:parent.openIframeLayer('{:url('details',['id'=>$vo.id])}','订单详情',{area: ['80%', '80%']});"
                                   data-toggle="tooltip" title="订单详情">
                                    <i class="layui-icon layui-icon-more"></i>
                                </a>
                            </div>
                        </td>

                    </tr>
                    <tr class="tr-footer">
                        <td colspan="5">
                            <span>联系人：{$vo.username}</span>
                            <span style="margin: 0 5px;">电话：{$vo.phone}</span>
                            <span>地址：{$vo.province}-{$vo.city}-{$vo.county} {$vo.address}</span>
                            <notempty name="$vo.admin_remark">
                                <div class="layui-font-orange" style="margin-top: 5px;">管理备注：{$vo.admin_remark}</div>
                            </notempty>
                        </td>
                    </tr>
                    <tr class="tr-pipe"></tr>
                    </tbody>
                </foreach>
            </table>
        </div>
    </div>
    <div class="pagination">{$page|default=''}</div>
</div>
</body>
</html>

<script src="__STATIC__/js/admin.js"></script>
<!--导出-->
<script>
    //导出
    $(".ajax-export").click(function () {
        //alert("正在开发中...");
        $(".is_export").val(1);
        $(".ajax-form").submit();
        $(".is_export").val(0);
        return false;
    });

    //搜索
    $(".bt_search").click(function () {
        $(".w-form-search").removeAttr('action');
        $(".w-form-search").attr('action', "/index.html");
        $(".w-form-search").submit();
    });
</script>
<script>
    layui.use(function () {
        var laydate = layui.laydate,
            element = layui.element,
            layer = layui.layer,
            util = layui.util;

        // 日期时间范围
        laydate.render({
            elem: '#laydate-range-datetime',
            type: 'datetime',
            range: true,
            format: 'yyyy-MM-dd HH:mm'
        });

        // hash 地址定位
        var hashName = 'tabid'; // hash 名称
        var layid = location.hash.replace(new RegExp('^#' + hashName + '='), ''); // 获取 lay-id 值
        let host1 = window.location.host;
        let host2 = document.domain;
        let host3 = location.hostname;
        //console.log(host1, host2, host3)

        // 初始切换
        element.tabChange('LAY-order-tab', layid);
        // 切换事件
        element.on('tab(LAY-order-tab)', function (obj) {
            location.hash = hashName + '=' + obj.index;
            //console.log(location.hash)
        });

        //操作订单
        util.on('lay-on', {
            //管理员添加备注信息
            'order-tips': function () {
                var orderId = $(this).attr("data-id"); //当前订单ID
                var value = $(this).attr("data-notes"); //当前订单备注信息
                console.log(orderId)
                console.log(value)


                layer.prompt({title: '请输入备注信息', value, formType: 2}, function (value, index, elem) {
                    if (value === '') return elem.focus();

                    $.ajax({
                        type: "POST",
                        url: "setRemark",
                        data: {id: orderId, admin_remark: value},
                        success: function (res) {
                            if (res.code == 1) {
                                layer.close(index);
                                layer.msg(res.msg, {icon: 1, time: 1000}, function () {
                                    location.reload();
                                });
                            } else {
                                layer.msg(res.msg, {icon: 7});
                            }
                        },
                    })
                });
            },

            //处理退款
            'order-refund': function () {
                var orderId = $(this).attr("data-id"); //当前订单ID

                layer.confirm('确认要通过审核？', {
                    btn: ['确定', '拒绝'] //按钮
                }, function () {
                    $.ajax({
                        url: 'confirmCancel',
                        type: "POST",
                        data: {id: orderId, status: 1},
                        success: function (res) {
                            if (res.code == 1) {
                                layer.msg(res.msg, {icon: 1, time: 1000}, function () {
                                    location.reload();
                                });
                            } else {
                                layer.msg(res.msg, {icon: 7});
                            }
                        }
                    });
                }, function () {
                    layer.prompt({title: '请输入拒绝原因', formType: 2}, function (value, index, elem) {
                        if (value === '') return elem.focus();

                        $.ajax({
                            url: 'confirmCancel',
                            type: "POST",
                            data: {id: orderId, status: 2, text: value},
                            success: function (res) {
                                if (res.code == 1) {
                                    layer.close(index);
                                    layer.msg(res.msg, {icon: 1, time: 1000}, function () {
                                        location.reload();
                                    });
                                } else {
                                    layer.msg(res.msg, {icon: 7});
                                }
                            }
                        });
                    });
                });
            },

            //打印小票
            'order-print': function () {
                var orderId = $(this).attr("data-id"); //当前订单ID

                layer.confirm('确认要打印小票？', {
                    btn: ['确定', '取消'] //按钮
                }, function () {
                    layer.msg('打印小票操作', {icon: 1});
                });
            },

            //核销订单
            'order-verify': function () {
                var orderId = $(this).attr("data-id"); //当前订单ID

                layer.confirm('确认要核销此订单？', {
                    btn: ['确定', '取消'] //按钮
                }, function () {
                    layer.msg('核销成功', {icon: 1});
                });
            },


            //自动发货按钮
            'send-confirm': function () {
                var orderId = $(this).attr("data-id"); //当前订单ID
                console.log(orderId)
                layer.confirm('确认配送？', {icon: 3}, function () {
                    $.ajax({
                        type: "POST",
                        url: "send_post",
                        data: {id: orderId, status: 4},
                        success: function (res) {
                            if (res.code == 1) {
                                layer.msg('操作成功!', {icon: 1, time: 1000}, function () {
                                    location.reload();
                                });
                            } else {
                                layer.msg(res.msg, {icon: 7});
                            }
                        },
                    })
                }, function () {
                    layer.msg('已取消!', {icon: 2});
                });
            },



            //拒绝退款
            'refund-reject': function () {
                var orderId = $(this).attr("data-id"); //当前订单ID
                console.log(orderId)
                layer.confirm('确认拒绝退款？', {icon: 3}, function () {
                    $.ajax({
                        type: "POST",
                        url: "reject_post",
                        data: {id: orderId, status: 14},
                        success: function (res) {
                            if (res.code == 1) {
                                layer.msg('操作成功!', {icon: 1, time: 1000}, function () {
                                    location.reload();
                                });
                            } else {
                                layer.msg(res.msg, {icon: 7});
                            }
                        },
                    })
                }, function () {
                    layer.msg('已取消!', {icon: 2});
                });
            },


            //同意退款
            'pass-reject': function () {
                var orderId = $(this).attr("data-id"); //当前订单ID
                console.log(orderId)
                layer.confirm('确认退款？', {icon: 3}, function () {
                    $.ajax({
                        type: "POST",
                        url: "reject_post",
                        data: {id: orderId, status: 16},
                        success: function (res) {
                            if (res.code == 1) {
                                layer.msg('操作成功!', {icon: 1, time: 1000}, function () {
                                    location.reload();
                                });
                            } else {
                                layer.msg(res.msg, {icon: 7});
                            }
                        },
                    })
                }, function () {
                    layer.msg('已取消!', {icon: 2});
                });
            },


        })
    })

    function send(id) {
        openIframeLayer(`{:url('order/send')}?id=${id}`, '订单发货', {
            area: ['800px', '600px'],
            btn: ['确定', '取消'],
            yes: function (index, layero) {

                var iframeWin = window[layero.find('iframe')[0]['name']];
                var str = iframeWin.confirm();
                var data = str['data'];

                if (!str.data.exp_id) {
                    layer.msg('请选择快递公司');
                    return;
                }

                if (!str.data.exp_num) {
                    layer.msg('请填写快递单号');
                    return;
                }
                $.ajax({
                    type: "POST",
                    url: "send",
                    data: data,
                    success: function (res) {
                        if (res.code == 1) {
                            layer.close(index);
                            layer.msg(res.msg, {icon: 1, time: 1000}, function () {
                                location.reload();
                            });
                        } else {
                            layer.msg(res.msg, {icon: 7});
                        }
                    },
                })
            }
        });
    }

    //展示退款图片
    function showPhotos(images, index) {
        layer.photos({
            photos: {
                "title": "Photos Demo",
                "start": index,
                "data": images
            }
        });
    }


    //悬浮提示
    $(function () {
        var tips;
        $('.order_num').on({
            //延时1秒
            mouseenter: function () {
                var that = this;
                tips = layer.tips("<span style='color:black;font-size: 15px;font-weight: 400;'>点击复制订单号</span>", that, {
                    tips: [1, '#efefef'],
                    time: 0,
                    area: 'auto',
                    maxWidth: 500
                });
            },

            //去除
            mouseleave: function () {
                layer.close(tips);
            }
        });


        $('.exp_num').on({
            mouseenter: function () {
                var that = this;
                tips = layer.tips("<span style='color:black;font-size: 15px;font-weight: 400;'>点击复制快递单号</span>", that, {
                    tips: [1, '#efefef'],
                    time: 0,
                    area: 'auto',
                    maxWidth: 500
                });
            },
            mouseleave: function () {
                layer.close(tips);
            }
        });


        $('.address').on({
            mouseenter: function () {
                var that = this;
                tips = layer.tips("<span style='color:black;font-size: 15px;font-weight: 400;'>点击复制地址信息</span>", that, {
                    tips: [1, '#efefef'],
                    time: 0,
                    area: 'auto',
                    maxWidth: 500
                });
            },
            mouseleave: function () {
                layer.close(tips);
            }
        });

    })

</script>
