<include file="public@header"/>
<link href="__TMPL__/public/assets/css/common.css" rel="stylesheet">
</head>
<body>
<div class="steps-section">
    <div class="warp">
        <div class="step">
            <div class="left">
                <img src="__TMPL__/public/assets/images/order/status_1_active.png" alt="" width="30" height="30">
                <div class="title active">已下单</div>
                <if condition="!empty($create_time)">
                    <div class="date">{$create_time|date="Y-m-d H:i:s"}</div>
                </if>
            </div>
            <div class="right">
                <div class="line"></div>
            </div>
        </div>
        <div class="step">
            <div class="left">
                <if condition="$status != 1 and $status != 10">
                    <img src="__TMPL__/public/assets/images/order/status_2_active.png" alt="" width="30" height="30">
                    <div class="title active">已付款</div>
                    <if condition="!empty($pay_time)">
                        <div class="date">{$pay_time|date="Y-m-d H:i:s"}</div>
                    </if>
                    <else/>
                    <img src="__TMPL__/public/assets/images/order/status_2.png" alt="" width="30" height="30">
                    <div class="title">已付款</div>
                </if>
            </div>
            <div class="right">
                <div class="line"></div>
            </div>
        </div>
        <div class="step">
            <div class="left">
                <if condition="$status != 1 and $status != 2 and $status != 10 and $status != 12 and $status != 14 and $status != 16">
                    <img src="__TMPL__/public/assets/images/order/status_3_active.png" alt="" width="30" height="30">
                    <div class="title active">已发货</div>
                    <if condition="!empty($send_time)">
                        <div class="date">{$send_time|date="Y-m-d H:i:s"}</div>
                    </if>
                    <else/>
                    <img src="__TMPL__/public/assets/images/order/status_3.png" alt="" width="30" height="30">
                    <div class="title">已发货</div>
                </if>
            </div>
            <div class="right">
                <div class="line"></div>
            </div>
        </div>
        <div class="step">
            <div class="left">
                <if condition="$status == 6">
                    <img src="__TMPL__/public/assets/images/order/status_4_active.png" alt="" width="30" height="30">
                    <div class="title active">已收货</div>
                    <if condition="!empty($receive_time)">
                        <div class="date">{$receive_time|date="Y-m-d H:i:s"}</div>
                    </if>
                    <else/>
                    <img src="__TMPL__/public/assets/images/order/status_4.png" alt="" width="30" height="30">
                    <div class="title">已收货</div>
                </if>
            </div>
            <div class="right">
                <div class="line"></div>
            </div>
        </div>
        <div class="step">
            <div class="left">
                <if condition="$status == 8">
                    <img src="__TMPL__/public/assets/images/order/status_6_active.png" alt="" width="30" height="30">
                    <div class="title active">已完成</div>
                    <if condition="!empty($accomplish_time)">
                        <div class="date">{$accomplish_time|date="Y-m-d H:i:s"}</div>
                    </if>
                    <else/>
                    <img src="__TMPL__/public/assets/images/order/status_6.png" alt="" width="30" height="30">
                    <div class="title">已完成</div>
                </if>
            </div>
            <div class="right">
                <div class="line"></div>
            </div>
        </div>
        <div class="step last">
            <div class="left">
                <if condition="$status == 10 or $status == 16 or $status == 20">
                    <img src="__TMPL__/public/assets/images/order/status_7_active.png" alt="" width="30" height="30">
                    <div class="title active">取消/关闭</div>
                    <if condition="!empty($cancel_time)">
                        <div class="date">{$cancel_time|date="Y-m-d H:i:s"}</div>
                    </if>
                    <else/>
                    <img src="__TMPL__/public/assets/images/order/status_7.png" alt="" width="37" height="37">
                    <div class="title">取消/关闭</div>
                </if>
            </div>
            <div class="right">
                <div class="line"></div>
            </div>
        </div>

    </div>
</div>
<div class="order-details">
    <div class="warp">
        <div class="layui-font-16"><b>订单信息</b></div>
        <div class="layui-row layui-col-space30" style="margin-top: 10px;">
            <div class="layui-col-md4">
                <div class="list-cell">
                    <span class="sub-title">订单号：</span>
                    <span onclick="copyContent('{$order_num}')">{$order_num}</span>
                </div>
                <div class="list-cell">
                    <span class="sub-title">用户信息：</span>
                    <span ondblclick="copyContent('{$user_info.openid}')">{$user_info.nickname}<cite>(ID:{$user_id})</cite></span>
                </div>
                <div class="list-cell">
                    <notempty name="$pay_time">
                        <span class="sub-title">支付方式：</span>
                        <!-- 0未支付, 1微信支付, 2余额支付, 3积分支付 -->
                        <span class="layui-btn layui-btn-primary layui-border-green layui-btn-xs">{$pay_type_name}</span>
                    </notempty>
                </div>
                <div class="list-cell">
                    <notempty name="$exp_name">
                        <span class="sub-title">快递名称：{$exp_name}</span>
                    </notempty>
                    <notempty name="$exp_num">
                        <br>
                        <span class="layui-font-blue">快递单号：<cite>({$exp_num})</cite></span>
                    </notempty>
                </div>
            </div>
            <div class="layui-col-md4">
                <div class="list-cell">
                    <span class="sub-title">联系人：</span>
                    <span>{$username}</span>
                </div>
                <div class="list-cell">
                    <span class="sub-title">电话：</span>
                    <span>{$phone}</span>
                </div>
                <div class="list-cell">
                    <span class="sub-title">收货地址：</span>
                    <span>{$province}-{$city}-{$county} {$address}</span>
                </div>
                <!--				<div class="list-cell">-->
                <!--					<span class="sub-title">配送方式：</span>-->
                <!--					<span class="layui-btn layui-btn-primary layui-border-green layui-btn-xs">快递发货</span>-->
                <!--				</div>-->
                <!--<div class="list-cell">
                    <span class="sub-title">核销员：</span>
                    <span>用户昵称<cite>(用户ID)</cite></span>
                </div>-->
            </div>
            <div class="layui-col-md4">
                <div class="list-cell">
                    <div class="sub-title">买家留言：</div>
                    <span>{$remark}</span>
                </div>
                <div class="list-cell">
                    <div class="sub-title">商家备注：</div>
                    <span>{$admin_remark}</span>
                    <!-- 如无留言为“添加备注”，否则为“修改备注” -->
                    <i class="layui-icon layui-icon-edit layui-font-blue cursor" lay-on="order-tips"
                       data-toggle="tooltip" title="{$admin_remark?'修改备注':'添加备注'}" data-id="{$id}"
                       data-notes="{$admin_remark}"></i>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="order-details" style="margin-bottom: 150px;">
    <div class="warp">
        <table class="table table-hover table-bordered">
            <thead>
            <tr class="active">
                <th class="text-center">商品信息</th>
                <th width="10%" class="text-center">规格</th>
                <th width="10%" class="text-center">单价</th>
                <th width="10%" class="text-center">划线价</th>
                <th width="10%" class="text-center">数量</th>
                <th width="10%" class="text-center">合计</th>
            </tr>
            </thead>
            <tbody>
            <foreach name="goods_list" item="vo" key="key">
                <tr>
                    <!--					<td class="text-center">{$key+1}</td>-->
                    <td class="goods-list">
                        <div class="img">
                            <img class="img-rounded" src="{:cmf_get_image_preview_url($vo.image)}" alt="" width="70"
                                 height="70">
                        </div>
                        <div class="title">{$vo.goods_name}</div>
                    </td>
                    <td class="text-center">
                        <if condition="$vo.sku_name">
                        <span class="tags">{$vo.sku_name}</span>
                        </if>
                    </td>
                    <td class="text-center">&yen; {$vo.goods_price}</td>
                    <td class="text-center">&yen; {$vo.line_price}</td>
                    <td class="text-center">{$vo.count}</td>
                    <td class="text-center">&yen; {$vo.total_amount}</td>
                </tr>
            </foreach>
            </tbody>
        </table>
        <div class="text-right" style="margin-top: 10px;">
            <span>运费</span>
            <b style="margin-left: 5px;">&yen; {$freight_amount}</b>
        </div>
        <div class="text-right" style="margin-top: 10px;">
            <span>实际支付</span>
            <b style="margin-left: 5px;">&yen; {$amount}</b>
        </div>
        <div class="text-right" style="margin-top: 10px;">
            <span>总计</span>
            <b style="margin-left: 5px;">&yen; {$total_amount}</b>
        </div>
        <!--		<div class="text-right" style="margin-top: 10px;">-->
        <!--			<span>实付款</span>-->
        <!--			<b class="layui-font-red" style="margin-left: 5px;">&yen; {$amount}</b>-->
        <!--			<cite>(优惠券 -{$coupon_amount})</cite>-->
        <!--		</div>-->
    </div>
    <!--	<div class="operate">-->
    <!--		<if condition="$status == 2 || $status == 14">-->
    <!--			<a class="layui-btn layui-bg-blue layui-btn-sm" onclick="send({$id});">立即发货</a>-->
    <!--			<elseif condition="$status == 12 or $status == 13"/>-->
    <!--			<div class="layui-btn layui-bg-red layui-btn-sm" lay-on="order-refund" data-toggle="tooltip" title="处理退款" data-id="{$id}">处理退款</div>-->
    <!--			<elseif condition="$status == 18"/>-->
    <!--			<a class="layui-bg-red-light layui-circle op-btn js-ajax-dialog-btn" href="{:url('order/confirmCancel',['id'=>$info['id']])}" data-msg="确定退款吗？">-->
    <!--				<i class="layui-icon layui-icon-util"></i>-->
    <!--			</a>-->
    <!--		</if>-->
    <!--		&lt;!&ndash;<div class="layui-btn layui-btn-sm" lay-on="order-print">打印小票</div>&ndash;&gt;-->
    <!--	</div>-->
</div>
<script src="__STATIC__/js/admin.js"></script>
<script>
    layui.use(function () {
        var layer = layui.layer;
        var util = layui.util;
        //操作订单
        util.on('lay-on', {
            //管理员添加备注信息
            'order-tips': function () {
                var orderId = $(this).attr("data-id"); //当前订单ID
                var value = $(this).attr("data-notes"); //当前订单备注信息

                layer.prompt({title: '请输入备注信息', value, formType: 2}, function (value, index, elem) {
                    if (value === '') return elem.focus();

                    $.ajax({
                        type: "POST",
                        url: "setRemark",
                        data: {id: orderId, remark: value},
                        success: function (res) {
                            if (res.code == 1) {
                                layer.close(index);
                                layer.msg(res.msg, {icon: 1, time: 1000}, function () {
                                    location.reload();
                                });
                            } else {
                                layer.msg(res.msg, {icon: 7});
                            }
                        },
                    })
                });
            },

            //处理退款
            'order-refund': function () {
                var orderId = $(this).attr("data-id"); //当前订单ID

                layer.confirm('确认要通过审核？', {
                    btn: ['确定', '拒绝'] //按钮
                }, function () {
                    $.ajax({
                        url: 'confirmCancel',
                        type: "POST",
                        data: {id: orderId, status: 1},
                        success: function (res) {
                            if (res.code == 1) {
                                layer.msg(res.msg, {icon: 1, time: 1000}, function () {
                                    location.reload();
                                });
                            } else {
                                layer.msg(res.msg, {icon: 7});
                            }
                        }
                    });
                }, function () {
                    layer.prompt({title: '请输入拒绝原因', formType: 2}, function (value, index, elem) {
                        if (value === '') return elem.focus();

                        $.ajax({
                            url: 'confirmCancel',
                            type: "POST",
                            data: {id: orderId, status: 2, text: value},
                            success: function (res) {
                                if (res.code == 1) {
                                    layer.close(index);
                                    layer.msg(res.msg, {icon: 1, time: 1000}, function () {
                                        location.reload();
                                    });
                                } else {
                                    layer.msg(res.msg, {icon: 7});
                                }
                            }
                        });
                    });
                });
            },

            //打印小票
            'order-print': function () {
                var orderId = $(this).attr("data-id"); //当前订单ID

                layer.confirm('确认要打印小票？', {
                    btn: ['确定', '取消'] //按钮
                }, function () {
                    layer.msg('打印小票操作', {icon: 1});
                });
            }
        })
    })

    function send(id) {
        openIframeLayer(`{:url('order/send')}?id=${id}`, '订单发货', {
            area: ['800px', '600px'],
            btn: ['确定', '取消'],
            yes: function (index, layero) {

                var iframeWin = window[layero.find('iframe')[0]['name']];
                var str = iframeWin.confirm();
                var data = str['data'];

                if (!str.data.exp_id) {
                    layer.msg('请选择快递公司');
                    return;
                }

                if (!str.data.exp_num) {
                    layer.msg('请填写快递单号');
                    return;
                }
                $.ajax({
                    type: "POST",
                    url: "send",
                    data: data,
                    success: function (res) {
                        if (res.code == 1) {
                            layer.close(index);
                            layer.msg(res.msg, {icon: 1, time: 1000}, function () {
                                location.reload();
                            });
                        } else {
                            layer.msg(res.msg, {icon: 7});
                        }
                    },
                })
            }
        });
    }
</script>
</body>
</html>