<include file="public@header"/>
<link href="__TMPL__/public/assets/css/common.css" rel="stylesheet">
</head>
<body>


<div class="steps-section" style="display: none;">
    <div class="warp">
        <div class="step">
            <div class="left">
                <img src="__TMPL__/public/assets/images/order/status_1_active.png" alt="" width="30" height="30">
                <div class="title active">已下单</div>
                <if condition="!empty($create_time)">
                    <div class="date">{$create_time|date="Y-m-d H:i:s"}</div>
                </if>
            </div>
            <div class="right">
                <div class="line"></div>
            </div>
        </div>
        <div class="step">
            <div class="left">
                <if condition="$status != 1 and $status != 10">
                    <img src="__TMPL__/public/assets/images/order/status_2_active.png" alt="" width="30" height="30">
                    <div class="title active">待接单</div>
                    <if condition="!empty($pay_time)">
                        <div class="date">{$pay_time|date="Y-m-d H:i:s"}</div>
                    </if>
                    <else/>
                    <img src="__TMPL__/public/assets/images/order/status_2.png" alt="" width="30" height="30">
                    <div class="title">待接单</div>
                </if>
            </div>
            <div class="right">
                <div class="line"></div>
            </div>
        </div>
        <div class="step">
            <div class="left">
                <if condition="$status != 1 and $status != 3 and $status != 4 and $status != 5 and $status != 10 and $status != 12 and $status != 14 and $status != 16">
                    <img src="__TMPL__/public/assets/images/order/status_3_active.png" alt="" width="30" height="30">
                    <div class="title active">待服务</div>
                    <if condition="!empty($receive_time)">
                        <div class="date">{$receive_time|date="Y-m-d H:i:s"}</div>
                    </if>
                    <else/>
                    <img src="__TMPL__/public/assets/images/order/status_3.png" alt="" width="30" height="30">
                    <div class="title">待服务</div>
                </if>
            </div>
            <div class="right">
                <div class="line"></div>
            </div>
        </div>
        <div class="step">
            <div class="left">
                <if condition="$status == 4">
                    <img src="__TMPL__/public/assets/images/order/status_4_active.png" alt="" width="30" height="30">
                    <div class="title active">服务中</div>
                    <if condition="!empty($service_time)">
                        <div class="date">{$service_time|date="Y-m-d H:i:s"}</div>
                    </if>
                    <else/>
                    <img src="__TMPL__/public/assets/images/order/status_4.png" alt="" width="30" height="30">
                    <div class="title">服务中</div>
                </if>
            </div>
            <div class="right">
                <div class="line"></div>
            </div>
        </div>
        <div class="step">
            <div class="left">
                <if condition="$status == 5">
                    <img src="__TMPL__/public/assets/images/order/status_6_active.png" alt="" width="30" height="30">
                    <div class="title active">已完成</div>
                    <if condition="!empty($accomplish_time)">
                        <div class="date">{$accomplish_time|date="Y-m-d H:i:s"}</div>
                    </if>
                    <else/>
                    <img src="__TMPL__/public/assets/images/order/status_6.png" alt="" width="30" height="30">
                    <div class="title">已完成</div>
                </if>
            </div>
            <div class="right">
                <div class="line"></div>
            </div>
        </div>
        <div class="step last">
            <div class="left">
                <if condition="$status == 10 or $status == 16 or $status == 20">
                    <img src="__TMPL__/public/assets/images/order/status_7_active.png" alt="" width="30" height="30">
                    <div class="title active">取消/关闭</div>
                    <if condition="!empty($cancel_time)">
                        <div class="date">{$cancel_time|date="Y-m-d H:i:s"}</div>
                    </if>
                    <else/>
                    <img src="__TMPL__/public/assets/images/order/status_7.png" alt="" width="37" height="37">
                    <div class="title">取消/关闭</div>
                </if>
            </div>
            <div class="right">
                <div class="line"></div>
            </div>
        </div>
    </div>
</div>


<div class="order-details">
    <div class="warp">
        <div class="layui-font-16"><b>订单信息</b></div>
        <div class="layui-row layui-col-space30" style="margin-top: 10px;">
            <div class="layui-col-md4">
                <div class="list-cell">
                    <span class="sub-title">订单号：</span>
                    <span onclick="copyContent('{$order_num}')">{$order_num}</span>
                </div>
                <div class="list-cell">
                    <span class="sub-title">用户信息：</span>
                    <span ondblclick="copyContent('{$user_info.openid}')">{$user_info.nickname}<cite>(ID:{$user_id})</cite></span>
                </div>
                <div class="list-cell">
                    <notempty name="$pay_time">
                        <span class="sub-title">支付方式：</span>
                        <!-- 0未支付, 1微信支付, 2余额支付, 3积分支付 -->
                        <span class="layui-btn layui-btn-primary layui-border-green layui-btn-xs">{$pay_type_text}</span>
                    </notempty>
                </div>

                <div class="list-cell">
                    <span class="sub-title">问题描述：</span>
                    {$accomplish_text}
                    <br>
                    <span class="sub-title">完成照片：</span>
                    <br>
                    <foreach name="$accomplish_images" item="value">
                        <a href="javascript:imagePreviewDialog('{:cmf_get_image_preview_url($value)}');">
                            <img src="{:cmf_get_image_preview_url($value)}"
                                 style="width:40px;height:40px; ">
                        </a>
                    </foreach>
                </div>
            </div>
            <div class="layui-col-md4">
                <div class="list-cell">
                    <span class="sub-title">游戏名：</span>
                    <span>{$name}</span>
                </div>
                <div class="list-cell">
                    <span class="sub-title">游戏内昵称：</span>
                    <span>{$play_name}</span>
                </div>
                <div class="list-cell">
                    <span class="sub-title">游戏内编号：</span>
                    <span>{$code}</span>
                </div>
                <div class="list-cell">
                    <span class="sub-title">区服：</span>
                    <span>{$area}</span>
                </div>
                <div class="list-cell">
                    <span class="sub-title">微信号：</span>
                    <span>{$wx}</span>
                </div>
<!--                <div class="list-cell">-->
<!--                    <span class="sub-title">陪玩人数：</span>-->
<!--                    <span>{$play_number}</span>-->
<!--                </div>-->

            </div>
            <div class="layui-col-md4">
                <div class="list-cell">
                    <div class="sub-title">买家留言：</div>
                    <span>{$remark}</span>
                </div>

                <div class="list-cell">
                    <div class="sub-title">下单时间：</div>
                    <span>{$create_time|date="Y-m-d H:i:s"}</span>
                </div>

                <div class="list-cell">
                    <div class="sub-title">支付时间：</div>
                    <span>{$pay_time|date="Y-m-d H:i:s"}</span>
                </div>
                <div class="list-cell">
                    <div class="sub-title">拒绝理由：</div>
                    <span>{$refuse}</span>
                </div>
                <!--                <div class="list-cell">-->
                <!--                    <div class="sub-title">商家备注：</div>-->
                <!--                    <span>{$admin_remark}</span>-->
                <!--                    &lt;!&ndash; 如无留言为“添加备注”，否则为“修改备注” &ndash;&gt;-->
                <!--                    <i class="layui-icon layui-icon-edit layui-font-blue cursor" lay-on="order-tips"-->
                <!--                       data-toggle="tooltip" title="{$admin_remark?'修改备注':'添加备注'}" data-id="{$id}"-->
                <!--                       data-notes="{$admin_remark}"></i>-->
                <!--                </div>-->
            </div>
        </div>
    </div>
</div>

<div class="order-details" style="margin-bottom: 10px;">
    <div class="warp">
        <table class="table table-hover table-bordered">
            <thead>
            <tr class="active">
                <th class="text-center">ID</th>
                <th class="text-center">陪玩</th>
                <th class="text-center">状态</th>
                <th class="text-center">操作记录</th>
                <th class="text-center">接单时间</th>

            </tr>
            </thead>
            <tbody>

            <foreach name="user_order_list" item="vo">
                <tr>
                    <td class="text-center"> {$vo.id}</td>
                    <td class="goods-list">
                        <if condition='!empty($vo.user_info.avatar)'>
                            <div class="img">
                                <img class="img-rounded" src="{:cmf_get_image_preview_url($vo.user_info.avatar)}" alt=""
                                     width="70"
                                     height="70">
                            </div>
                        </if>
                        <div class="title">
                            <div  ondblclick="copyContent('{$vo.user_info.openid}')">
                            {$vo.user_info.nickname}
                            <br>
                            {$vo.user_info.phone}
                            </div>
                        </div>
                    </td>
                    <td class="text-center"> {$vo.status_text}</td>
                    <td class="text-center"> {$vo.remark}</td>
                    <td class="text-center"> {$vo.create_time|date="Y-m-d H:i:s"}</td>
                </tr>
            </foreach>
            </tbody>
        </table>
    </div>
</div>


<div class="order-details" style="margin-bottom: 150px;">
    <div class="warp">
        <table class="table table-hover table-bordered">
            <thead>
            <tr class="active">
                <th class="text-center">商品信息</th>
                <th width="10%" class="text-center">单价</th>
                <th width="10%" class="text-center">数量</th>
                <th width="10%" class="text-center">合计</th>
            </tr>
            </thead>
            <tbody>
            <tr>
                <td class="goods-list">
                    <div class="img">
                        <img class="img-rounded" src="{:cmf_get_image_preview_url($image)}" alt="" width="70"
                             height="70">
                    </div>
                    <div class="title">
                        {$name}
                        <br>
                        <if condition="$sku_name">
                            <span class="tags">{$sku_name}</span>
                        </if>
                    </div>
                </td>
                <td class="text-center">&yen; {$goods_price}</td>
                <td class="text-center">{$count}</td>
                <td class="text-center">&yen; {$amount}</td>
            </tr>
            </tbody>
        </table>
        <div class="text-right" style="margin-top: 10px;">
            <span>优惠金额</span>
            <b style="margin-left: 5px;">&yen; {$coupon_amount}</b>
        </div>
        <div class="text-right" style="margin-top: 10px;">
            <span>实际支付</span>
            <b style="margin-left: 5px;">&yen; {$amount}</b>
        </div>
        <div class="text-right" style="margin-top: 10px;">
            <span>总计</span>
            <b style="margin-left: 5px;">&yen; {$total_amount}</b>
        </div>
        <!--		<div class="text-right" style="margin-top: 10px;">-->
        <!--			<span>实付款</span>-->
        <!--			<b class="layui-font-red" style="margin-left: 5px;">&yen; {$amount}</b>-->
        <!--			<cite>(优惠券 -{$coupon_amount})</cite>-->
        <!--		</div>-->
    </div>
    <!--	<div class="operate">-->
    <!--		<if condition="$status == 2 || $status == 14">-->
    <!--			<a class="layui-btn layui-bg-blue layui-btn-sm" onclick="send({$id});">立即发货</a>-->
    <!--			<elseif condition="$status == 12 or $status == 13"/>-->
    <!--			<div class="layui-btn layui-bg-red layui-btn-sm" lay-on="order-refund" data-toggle="tooltip" title="处理退款" data-id="{$id}">处理退款</div>-->
    <!--			<elseif condition="$status == 18"/>-->
    <!--			<a class="layui-bg-red-light layui-circle op-btn js-ajax-dialog-btn" href="{:url('order/confirmCancel',['id'=>$info['id']])}" data-msg="确定退款吗？">-->
    <!--				<i class="layui-icon layui-icon-util"></i>-->
    <!--			</a>-->
    <!--		</if>-->
    <!--		&lt;!&ndash;<div class="layui-btn layui-btn-sm" lay-on="order-print">打印小票</div>&ndash;&gt;-->
    <!--	</div>-->
</div>


<script src="__STATIC__/js/admin.js"></script>
<script>
    layui.use(function () {
        var layer = layui.layer;
        var util = layui.util;
        //操作订单
        util.on('lay-on', {
            //管理员添加备注信息
            'order-tips': function () {
                var orderId = $(this).attr("data-id"); //当前订单ID
                var value = $(this).attr("data-notes"); //当前订单备注信息

                layer.prompt({title: '请输入备注信息', value, formType: 2}, function (value, index, elem) {
                    if (value === '') return elem.focus();

                    $.ajax({
                        type: "POST",
                        url: "setRemark",
                        data: {id: orderId, remark: value},
                        success: function (res) {
                            if (res.code == 1) {
                                layer.close(index);
                                layer.msg(res.msg, {icon: 1, time: 1000}, function () {
                                    location.reload();
                                });
                            } else {
                                layer.msg(res.msg, {icon: 7});
                            }
                        },
                    })
                });
            },

            //处理退款
            'order-refund': function () {
                var orderId = $(this).attr("data-id"); //当前订单ID

                layer.confirm('确认要通过审核？', {
                    btn: ['确定', '拒绝'] //按钮
                }, function () {
                    $.ajax({
                        url: 'confirmCancel',
                        type: "POST",
                        data: {id: orderId, status: 1},
                        success: function (res) {
                            if (res.code == 1) {
                                layer.msg(res.msg, {icon: 1, time: 1000}, function () {
                                    location.reload();
                                });
                            } else {
                                layer.msg(res.msg, {icon: 7});
                            }
                        }
                    });
                }, function () {
                    layer.prompt({title: '请输入拒绝原因', formType: 2}, function (value, index, elem) {
                        if (value === '') return elem.focus();

                        $.ajax({
                            url: 'confirmCancel',
                            type: "POST",
                            data: {id: orderId, status: 2, text: value},
                            success: function (res) {
                                if (res.code == 1) {
                                    layer.close(index);
                                    layer.msg(res.msg, {icon: 1, time: 1000}, function () {
                                        location.reload();
                                    });
                                } else {
                                    layer.msg(res.msg, {icon: 7});
                                }
                            }
                        });
                    });
                });
            },

            //打印小票
            'order-print': function () {
                var orderId = $(this).attr("data-id"); //当前订单ID

                layer.confirm('确认要打印小票？', {
                    btn: ['确定', '取消'] //按钮
                }, function () {
                    layer.msg('打印小票操作', {icon: 1});
                });
            }
        })
    })

    function send(id) {
        openIframeLayer(`{:url('order/send')}?id=${id}`, '订单发货', {
            area: ['800px', '600px'],
            btn: ['确定', '取消'],
            yes: function (index, layero) {

                var iframeWin = window[layero.find('iframe')[0]['name']];
                var str = iframeWin.confirm();
                var data = str['data'];

                if (!str.data.exp_id) {
                    layer.msg('请选择快递公司');
                    return;
                }

                if (!str.data.exp_num) {
                    layer.msg('请填写快递单号');
                    return;
                }
                $.ajax({
                    type: "POST",
                    url: "send",
                    data: data,
                    success: function (res) {
                        if (res.code == 1) {
                            layer.close(index);
                            layer.msg(res.msg, {icon: 1, time: 1000}, function () {
                                location.reload();
                            });
                        } else {
                            layer.msg(res.msg, {icon: 7});
                        }
                    },
                })
            }
        });
    }
</script>
</body>
</html>